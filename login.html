<!DOCTYPE html>
<html>
<head>
<base target="_top">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
html,body{height:100%;margin:0}
body{display:flex;align-items:center;justify-content:center;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
.card{width:320px}
.row{margin:8px 0}
label{display:block;margin-bottom:4px}
input{width:100%;height:36px;box-sizing:border-box}
button{height:36px}
.actions{margin-top:12px}
.recovery-step{margin-top:8px}
#loader{position:fixed;top:0;left:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;flex-direction:column;background:rgba(0,0,0,0.2);backdrop-filter:blur(6px)}
.spinner{width:48px;height:48px;border:5px solid #c7c7c7;border-top-color:#333;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:12px}
@keyframes spin{to{transform:rotate(360deg)}}
#loader-text{font-weight:600}
dialog{border:none;border-radius:8px;padding:16px}
dialog::backdrop{background:rgba(0,0,0,0.25);backdrop-filter:blur(6px)}
</style>
</head>
<body>
<!-- Full-page loader and modal dialog for user feedback -->
<div id="loader"><div class="spinner"></div><div id="loader-text">Loading...</div></div>
<dialog id="dialog"><p id="dialog-text"></p><div class="actions"><button type="button" onclick="closeDialog()">Close</button></div></dialog>
<main class="card" role="main">
  <!-- Login form -->
  <section id="login-section" aria-labelledby="login-title">
    <h1 id="login-title">Login</h1>
    <form id="login-form" novalidate>
      <div class="row">
        <label for="username">Username</label>
        <input id="username" name="username" type="text" autocomplete="off" required>
      </div>
      <div class="row">
        <label for="password">Password</label>
        <input id="password" name="password" type="password" autocomplete="off" required>
      </div>
      <div class="actions">
        <button id="login-button" type="button" onclick="handleLogin()">Login</button>
        <button type="button" onclick="showRecovery()">Forgot password?</button>
      </div>
    </form>
  </section>

  <!-- Password recovery flow -->
  <section id="recovery-section" aria-labelledby="recovery-title" hidden>
    <h2 id="recovery-title">Password Recovery</h2>
    <form id="recovery-form" novalidate>
      <div class="recovery-step" id="recovery-step1">
        <label for="recovery-identifier">Username or Email</label>
        <input id="recovery-identifier" name="identifier" type="text" autocomplete="off" required>
        <div class="actions">
          <button type="button" onclick="sendRecoveryCode()">Send Code</button>
          <button type="button" onclick="backToLogin()">Back to login</button>
        </div>
      </div>
      <div class="recovery-step" id="recovery-step2" hidden>
        <label for="recovery-code">Verification Code</label>
        <input id="recovery-code" name="code" type="text" autocomplete="off" required>
        <label for="new-password" style="margin-top:8px">New Password</label>
        <input id="new-password" name="newPassword" type="password" autocomplete="off" required>
        <label for="confirm-password" style="margin-top:8px">Confirm Password</label>
        <input id="confirm-password" name="confirmPassword" type="password" autocomplete="off" required>
        <div class="actions">
          <button type="button" onclick="resetPassword()">Reset Password</button>
          <button type="button" onclick="resendCode()">Resend Code</button>
          <button type="button" onclick="backToLogin()">Back to login</button>
        </div>
      </div>
    </form>
  </section>
</main>
<script>
// Attempts login, then renders returned page HTML
function handleLogin(){
  const u=document.getElementById('username').value.trim();
  const p=document.getElementById('password').value.trim();
  if(!u||!p){showDialog('Please enter both username and password.');return;}
  showLoader('Logging in...');
  google.script.run.withSuccessHandler((response)=>{
    hideLoader();
    if(response&&response.success===false){showDialog(response.message);return;}
    document.open();document.write(response);document.close();
  }).validateLogin(u,p);
}
// Shows recovery section
function showRecovery(){
  document.getElementById('login-section').hidden=true;
  document.getElementById('recovery-section').hidden=false;
  document.getElementById('recovery-step1').hidden=false;
  document.getElementById('recovery-step2').hidden=true;
}
// Returns to login view
function backToLogin(){
  document.getElementById('recovery-section').hidden=true;
  document.getElementById('login-section').hidden=false;
  document.getElementById('recovery-step2').hidden=true;
}
// Sends recovery code to user via server
function sendRecoveryCode(){
  const id=document.getElementById('recovery-identifier').value.trim();
  if(!id){showDialog('Enter username or email.');return;}
  showLoader('Sending recovery code...');
  google.script.run.withSuccessHandler((res)=>{
    hideLoader();
    if(!res||res.success===false){showDialog(res&&res.message?res.message:'Failed to send code');return;}
    showDialog('Verification code sent to registered email.');
    document.getElementById('recovery-step1').hidden=true;
    document.getElementById('recovery-step2').hidden=false;
  }).processPasswordRecovery(id);
}
// Resets password using the code
function resetPassword(){
  const id=document.getElementById('recovery-identifier').value.trim();
  const code=document.getElementById('recovery-code').value.trim();
  const np=document.getElementById('new-password').value.trim();
  const cp=document.getElementById('confirm-password').value.trim();
  if(!id||!code||!np||!cp){showDialog('Complete all fields.');return;}
  if(np!==cp){showDialog('Passwords do not match.');return;}
  showLoader('Resetting password...');
  google.script.run.withSuccessHandler((res)=>{
    hideLoader();
    if(!res||res.success===false){showDialog(res&&res.message?res.message:'Failed to reset password');return;}
    showDialog('Password updated. You can login now.');
    backToLogin();
  }).resetPassword(id,code,np);
}
// Shows first recovery step again and clears inputs
function resendCode(){
  document.getElementById('recovery-step2').hidden=true;
  document.getElementById('recovery-step1').hidden=false;
  document.getElementById('recovery-code').value='';
  document.getElementById('new-password').value='';
  document.getElementById('confirm-password').value='';
}
// Loader and dialog helpers (local to login page)
function showLoader(message){
  document.getElementById('loader-text').textContent=message||'Loading...';
  document.getElementById('loader').style.display='flex';
}
function hideLoader(){
  document.getElementById('loader').style.display='none';
}
function showDialog(message){
  document.getElementById('dialog-text').textContent=message||'';
  document.getElementById('dialog').showModal();
}
function closeDialog(){
  document.getElementById('dialog').close();
}
</script>
</body>
</html>
